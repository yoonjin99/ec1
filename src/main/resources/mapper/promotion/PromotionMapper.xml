<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 줄맞추기 -->
<mapper namespace="com.plateer.ec1.promotion.mapper.PromotionMapper">
    <!-- 다운로드 가능한 쿠폰 확인 -->
    <select id="selectAvailableCoupon" resultType="com.plateer.ec1.promotion.vo.CouponVo" parameterType="com.plateer.ec1.promotion.vo.CouponRequestVo">
      select
        cpb.prm_no
        , cpb.prm_nm
        , ccb.dwl_psb_cnt
        , ccb.psn_dwl_psb_cnt
        , (select count(prm_no) from cc_cpn_issue where prm_no = #{prmNo}) as tot_cnt
        , (select count(prm_no) from cc_cpn_issue where prm_no = #{prmNo} and mbr_no = #{mbrNo}) as mbr_cnt
        , (case when cpb.prm_priod_ccd = '10' then cpb.prm_strt_dt
             else cpb.sys_mod_dtime
           end) as prm_strt_dt
        , (case when cpb.prm_priod_ccd = '10' then cpb.prm_end_dt
                else cpb.sys_mod_dtime::date + cpb.prm_std_dd
            end) as prm_end_dt
      from
        cc_prm_base cpb
        inner join cc_cpn_base ccb
        on cpb.prm_no = ccb.prm_no
      where
        cpb.use_yn = 'Y'
        and cpb.prm_no = #{prmNo}
        and now() between ccb.dwl_avl_strt_dd::date and ccb.dwl_avl_end_dd::date + 1
    </select>

    <!-- 다운로드 받은 쿠폰 목록 -->
    <select id="selectDownloadCouponList" parameterType="string" resultType="com.plateer.ec1.promotion.vo.PromotionVo">
        select
            /* PromotionMapper.selectDownloadCouponList */
            cpb.prm_no,
            cpb.prm_nm,
            cci.cpn_iss_no
        from
            cc_prm_base cpb
            inner join cc_cpn_issue cci
            on cpb.prm_no = cci.prm_no
            and cci.mbr_no = #{mbrNo}
    </select>

    <!-- 복원 가능한 쿠폰인지 확인 -->
    <select id="selectAvailableRestoreCoupon" parameterType="com.plateer.ec1.promotion.vo.CouponRequestVo" resultType="com.plateer.ec1.promotion.vo.CouponVo">
        select
            /* PromotionMapper.selectAvailableRestoreCoupon */
          cci.prm_no
        , cci.use_strt_dtime as prm_strt_dt
        , cci.use_end_dtime as prm_end_dt
        from cc_cpn_issue cci
        where
          cci.prm_no = #{prmNo}
          and cci.cpn_iss_no = #{couponIssueNo}
          and now() between cci.use_strt_dtime::date and cci.use_end_dtime::date + 1
    </select>

    <sql id="commonQuery">
      from
        cc_prm_base cpb
        inner join cc_prm_aply_tgt cpat
        on cpb.prm_no = cpat.prm_no
        inner join cc_cpn_issue cci
        on cpb.prm_no = cci.prm_no
        and cci.mbr_no = #{mbrNo}
        inner join cc_cpn_base ccb
        on ccb.prm_no = cpb.prm_no
        inner join pr_goods_base pgb
        on cpat.aply_tgt_no = pgb.goods_no
      <where>
        and cpb.use_yn = 'Y'
        and cci.cpn_use_dt is null
        and cpb.prm_kind_cd = '20'
        and now() between cci.use_strt_dtime::date and cci.use_end_dtime::date + 1
        and aply_tgt_no in
        <foreach collection="products" item="item" open="(" close=")" separator=",">
          #{item.goodsNo}
        </foreach>
      </where>
    </sql>

    <!-- 상품에 적용 가능한 쿠폰 목록 -->
    <select id="selectAvailablePromotionList" resultType="com.plateer.ec1.promotion.vo.ProductCouponsVo" parameterType="com.plateer.ec1.promotion.vo.PromotionRequestVo">
      select
        /* PromotionMapper.selectAvailablePromtionList */
        cpb.prm_no
        , cpb.prm_nm
        , cpb.dc_val
        , cpb.min_pur_amt
        , cpb.max_dc_amt
        , cpb.dc_ccd
        , ccb.cpn_kind_cd
        , cci.cpn_iss_no
        , pgb.goods_no
        , COALESCE(pgb.prm_prc, pgb.sale_prc) as prd_price
      <include refid="commonQuery"></include>
        and ccb.cpn_kind_cd in ('10','20')

      union all

      select
        /* PromotionMapper.selectAvailablePromtionList */
        cpb.prm_no
        , cpb.prm_nm
        , cpb.dc_val
        , cpb.min_pur_amt
        , cpb.max_dc_amt
        , cpb.dc_ccd
        , ccb.cpn_kind_cd
        , cci.cpn_iss_no
        , ARRAY_TO_STRING(ARRAY_AGG(pgb.goods_no),',') as goods_no
        , 0 as prd_price
      <include refid="commonQuery"></include>
        and ccb.cpn_kind_cd = '30'
      group by cpb.prm_no, cpb.prm_nm, cpb.dc_val, cpb.min_pur_amt, cpb.max_dc_amt, cpb.dc_ccd, ccb.cpn_kind_cd, cci.cpn_iss_no
      order by cpn_iss_no
    </select>

</mapper>